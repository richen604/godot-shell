#!/usr/bin/env bash
# Pre-push hook to sync DVC data to remote before pushing Git changes
# This ensures that DVC-tracked data is available when others pull the changes

# Only run if DVC is initialized and remote is configured
if [ ! -f ".dvc/config" ] && [ ! -f "dvc.yaml" ] && ! find . -maxdepth 2 -name "*.dvc" -type f | grep -q .; then
    exit 0  # No DVC in this project
fi

# Check if DVC command is available
if ! command -v dvc >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  DVC command not found, skipping data push"
    exit 0
fi

# Check if any DVC remote is configured
if ! dvc remote list >/dev/null 2>&1 || [ -z "$(dvc remote list 2>/dev/null)" ]; then
    echo "‚ö†Ô∏è  No DVC remote configured, skipping data push"
    exit 0
fi

# Get the commits being pushed
remote="$1"
url="$2"

# Read from stdin to get the range of commits being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Branch is being deleted, no need to push DVC data
        continue
    fi
    
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, check if there are any DVC files in the branch
        dvc_files_exist=$(git ls-tree -r "$local_sha" | grep -E '\.dvc$' | wc -l)
        if [ "$dvc_files_exist" -gt 0 ]; then
            echo "üîÑ New branch with DVC files detected, pushing data..."
            need_push=true
            break
        fi
    else
        # Check if any .dvc files changed in the commit range
        dvc_files_changed=$(git diff --name-only "$remote_sha".."$local_sha" | grep -E '\.dvc$' | wc -l)
        if [ "$dvc_files_changed" -gt 0 ]; then
            echo "üîÑ DVC files changed, pushing data..."
            need_push=true
            break
        fi
    fi
done

# Only push DVC data if we detected changes
if [ "${need_push:-false}" = "true" ]; then
    echo "üì¶ Pushing DVC data to remote..."
    if dvc push 2>/dev/null; then
        echo "‚úÖ DVC data pushed successfully"
    else
        echo "‚ö†Ô∏è  DVC push failed - continuing with git push"
        echo "   You may need to run 'dvc push' manually"
        # Don't block git push even if DVC push fails
    fi
fi

exit 0
