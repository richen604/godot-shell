#!/usr/bin/env bash
# Post-merge hook to sync DVC data after merging/pulling changes
# This ensures DVC-tracked data is current after incorporating remote changes

# Only run if DVC is initialized
if [ ! -f ".dvc/config" ] && [ ! -f "dvc.yaml" ] && ! find . -maxdepth 2 -name "*.dvc" -type f | grep -q .; then
    exit 0  # No DVC in this project
fi

# Check if DVC command is available
if ! command -v dvc >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  DVC command not found, skipping data sync"
    exit 0
fi

# Check if any .dvc files were modified in the merge
# We can detect this by checking the merge commit for .dvc file changes
merge_head=$(git rev-parse HEAD)
merge_parent1=$(git rev-parse HEAD^1 2>/dev/null || echo "")
merge_parent2=$(git rev-parse HEAD^2 2>/dev/null || echo "")

dvc_files_changed=false

# Check if any .dvc files changed in the merge
if [ -n "$merge_parent1" ] && [ -n "$merge_parent2" ]; then
    # This was a real merge (not a fast-forward)
    if git diff --name-only "$merge_parent1" "$merge_head" | grep -E '\.dvc$' >/dev/null 2>&1; then
        dvc_files_changed=true
    fi
elif [ -n "$merge_parent1" ]; then
    # This was a fast-forward or regular commit
    if git diff --name-only "$merge_parent1" "$merge_head" | grep -E '\.dvc$' >/dev/null 2>&1; then
        dvc_files_changed=true
    fi
fi

# Always run checkout if DVC files changed, or if we can't determine the merge status
if [ "$dvc_files_changed" = "true" ] || [ -z "$merge_parent1" ]; then
    echo "üîÑ DVC files detected in merge, syncing data..."
    
    # Try to fetch from remote if configured (optional)
    if dvc remote list >/dev/null 2>&1 && [ -n "$(dvc remote list 2>/dev/null)" ]; then
        echo "üì• Fetching latest DVC data from remote..."
        if ! dvc fetch 2>/dev/null; then
            echo "‚ö†Ô∏è  DVC fetch failed, proceeding with local checkout"
        fi
    fi
    
    # Always run checkout to sync workspace
    if dvc checkout 2>/dev/null; then
        echo "‚úÖ DVC data synchronized"
    else
        echo "‚ö†Ô∏è  DVC checkout failed - some data files may not be available"
        echo "   Run 'dvc checkout' manually if needed"
    fi
fi

exit 0
